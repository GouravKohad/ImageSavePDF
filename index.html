<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Image Projects → PDF (Modern)</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js" crossorigin="anonymous"></script>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/regular/style.css" rel="stylesheet">

<style>
  :root{
    --bg:#0b1220; --panel:#0f1724; --muted:#101827; --text:#e7eef8; --sub:rgba(230,238,248,.75);
    --accent:#60a5fa; --accent2:#7c3aed; --success:#34d399; --warn:#f59e0b; --danger:#ef4444;
    --radius:14px; --glass:rgba(255,255,255,.04);
  }
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#071021,#060c19);color:var(--text)}
  .app{max-width:1200px;margin:20px auto;padding:18px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .brand{display:flex;gap:10px;align-items:center}
  .brand h1{font-size:20px;margin:0}
  .chip{padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));font-weight:700}

  .layout{display:grid;grid-template-columns:340px 1fr;gap:18px;margin-top:16px}
  @media (max-width:980px){ .layout{grid-template-columns:1fr} }

  .card{background:linear-gradient(180deg,var(--panel),rgba(15,20,36,0.95));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:0 16px 50px rgba(2,6,23,.6)}
  .sidebar{padding:14px;height:78vh;display:flex;flex-direction:column;gap:12px}
  .main{padding:14px;height:78vh;display:flex;flex-direction:column;gap:12px}

  .row{display:flex;gap:10px;align-items:center}
  input[type="text"], select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:var(--muted);color:var(--text);font-size:15px;outline:none}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:white}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.12);color:var(--text)}
  .btn.warn{background:linear-gradient(135deg,#f97316,#f59e0b);color:#1a1206}
  .btn.danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
  .btn.sm{padding:8px 10px;border-radius:10px;font-size:14px}

  .project-wrap{display:flex;flex-direction:column;gap:8px;flex:1;min-height:0}
  .project-list{flex:1;overflow:auto;border-radius:12px;padding:8px;background:rgba(255,255,255,.02)}
  .project-item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:12px;border-radius:12px;border:1px solid transparent;transition:transform .15s, background .15s}
  .project-item:hover{background:var(--glass);transform:translateY(-2px)}
  .project-item.active{outline:2px solid rgba(96,165,250,.25);background:rgba(96,165,250,.06)}
  .project-title{font-weight:700}
  .muted{color:var(--sub);font-size:13px}

  .dropzone{border:2px dashed rgba(255,255,255,.1);border-radius:14px;padding:18px;display:flex;align-items:center;justify-content:center;min-height:120px}
  .dropzone.drag{border-color:var(--accent);background:rgba(96,165,250,.06)}
  .grid{flex:1;overflow:auto;border-radius:12px;padding:10px;background:rgba(255,255,255,.02);display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px}
  .thumb{position:relative;height:160px;border-radius:12px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015));border:1px solid rgba(255,255,255,.06);box-shadow:0 12px 30px rgba(0,0,0,.35);transition:transform .18s}
  .thumb:hover{transform:translateY(-6px)}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .badge{position:absolute;left:8px;top:8px;background:rgba(0,0,0,.5);padding:4px 8px;border-radius:999px;font-size:12px}
  .thumb .actions{position:absolute;right:8px;top:8px;display:flex;gap:6px}
  .icon-btn{border:0;border-radius:10px;padding:6px;background:rgba(0,0,0,.45);color:#fff;cursor:pointer}
  .counts{display:flex;gap:10px;align-items:center}

  /* Modal viewer/editor */
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,.8);z-index:50;opacity:0;visibility:hidden;transition:opacity .2s}
  .modal.show{opacity:1;visibility:visible}
  .editor{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:14px;max-width:96vw;max-height:92vh;padding:12px;display:flex;flex-direction:column;gap:10px}
  .toolbar{display:flex;justify-content:space-between;align-items:center;gap:10px}
  canvas{background:#0a1424;border-radius:12px;max-width:88vw;max-height:70vh}

  /* Popup / Toast */
  .popup{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,.6);z-index:60;opacity:0;visibility:hidden;transition:opacity .2s}
  .popup.show{opacity:1;visibility:visible}
  .box{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:18px;max-width:720px;width:94%;box-shadow:0 24px 70px rgba(0,0,0,.6)}
  .toast{position:fixed;right:20px;bottom:20px;background:linear-gradient(135deg,var(--success),#10b981);color:#053a2a;padding:12px 16px;border-radius:12px;font-weight:700;z-index:70;opacity:0;transform:translateY(10px);transition:opacity .2s,transform .2s}
  .toast.show{opacity:1;transform:translateY(0)}

  /* Scrollbars (separate) */
  .project-list::-webkit-scrollbar{width:10px}
  .grid::-webkit-scrollbar{width:10px}
  .project-list::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--accent),var(--accent2));border-radius:999px}
  .grid::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#22c55e,#06b6d4);border-radius:999px}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <i class="ph ph-images" style="font-size:22px"></i>
        <h1>Image Projects → PDF</h1>
        <span class="chip">Offline • IndexedDB</span>
      </div>
      <div class="row">
        <input id="searchProjects" type="text" placeholder="Search projects…">
        <select id="theme">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
          <option value="pastel">Pastel</option>
        </select>
        <button id="howBtn" class="btn ghost sm"><i class="ph ph-info"></i> How to use</button>
      </div>
    </header>

    <div class="layout">
      <!-- Sidebar -->
      <aside class="card sidebar">
        <div class="row">
          <input id="projectName" type="text" placeholder="New project name">
          <button id="createBtn" class="btn primary"><i class="ph ph-plus"></i> New</button>
        </div>
        <div class="row">
          <button id="renameBtn" class="btn ghost sm"><i class="ph ph-pencil"></i> Rename</button>
          <button id="dupBtn" class="btn ghost sm"><i class="ph ph-copy"></i> Duplicate</button>
          <button id="delBtn" class="btn warn sm"><i class="ph ph-trash"></i> Delete</button>
        </div>

        <div class="project-wrap">
          <div class="row" style="justify-content:space-between">
            <div class="muted">Projects</div>
            <button id="refreshBtn" class="btn ghost sm"><i class="ph ph-arrow-clockwise"></i> Refresh</button>
          </div>
          <div id="projectList" class="project-list"></div>
        </div>

        <div class="row">
          <button id="exportAllBtn" class="btn ghost sm"><i class="ph ph-file-archive"></i> Export All</button>
          <button id="importBtn" class="btn ghost sm"><i class="ph ph-upload"></i> Import</button>
          <input id="importFile" type="file" accept="application/json" style="display:none">
        </div>
      </aside>

      <!-- Main -->
      <main class="card main">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <label class="btn ghost" for="fileInput" style="cursor:pointer"><i class="ph ph-image"></i> Add Images
              <input id="fileInput" type="file" accept="image/*" multiple style="display:none">
            </label>
            <button id="saveBtn" class="btn primary"><i class="ph ph-floppy-disk"></i> Save</button>
            <button id="pdfBtn" class="btn primary"><i class="ph ph-file-pdf"></i> Export PDF</button>
            <button id="zipBtn" class="btn ghost"><i class="ph ph-file-archive"></i> Export ZIP</button>
            <button id="shareBtn" class="btn ghost"><i class="ph ph-share-network"></i> Share</button>
          </div>
          <div class="counts">
            <span id="imgCount" class="muted pill">0 images</span>
            <span class="muted">Quality</span>
            <input id="quality" type="range" min="40" max="95" value="85">
            <span id="qualityVal" class="muted">85</span>
          </div>
        </div>

        <div id="dropzone" class="dropzone"><i class="ph ph-upload-simple" style="margin-right:8px"></i> Drag & drop images here</div>
        <div id="grid" class="grid"></div>
      </main>
    </div>
  </div>

  <!-- Editor Modal -->
  <div id="editorModal" class="modal" aria-hidden="true">
    <div class="editor">
      <div class="toolbar">
        <div class="row">
          <button id="prevImg" class="btn ghost sm"><i class="ph ph-caret-left"></i></button>
          <span id="pageLabel" class="muted">0 / 0</span>
          <button id="nextImg" class="btn ghost sm"><i class="ph ph-caret-right"></i></button>
        </div>
        <div class="row">
          <button id="rotL" class="btn ghost sm"><i class="ph ph-arrow-counter-clockwise"></i> Rotate</button>
          <button id="rotR" class="btn ghost sm"><i class="ph ph-arrow-clockwise"></i> Rotate</button>
          <button id="flipH" class="btn ghost sm"><i class="ph ph-arrows-left-right"></i> Flip H</button>
          <button id="flipV" class="btn ghost sm"><i class="ph ph-arrows-up-down"></i> Flip V</button>
          <button id="cropBtn" class="btn ghost sm"><i class="ph ph-crop"></i> Crop</button>
          <button id="closeEditor" class="btn primary"><i class="ph ph-x"></i> Close</button>
        </div>
      </div>
      <canvas id="canvas"></canvas>
      <div class="row" style="justify-content:center">
        <button id="dlImg" class="btn ghost sm"><i class="ph ph-download-simple"></i> Download</button>
        <button id="delImg" class="btn danger sm"><i class="ph ph-trash"></i> Delete</button>
      </div>
    </div>
  </div>

  <!-- How-to popup -->
  <div id="howPopup" class="popup" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 6px 0">Welcome! How to use</h2>
      <ol style="margin:8px 0 0 18px;line-height:1.6">
        <li>Create a project and it appears in the left list.</li>
        <li>Add images via button or drag & drop.</li>
        <li>Thumbnails can be dragged to reorder pages.</li>
        <li>Right-click a thumbnail to preview/edit. Use ←/→ to navigate, see page numbers.</li>
        <li>Export PDF keeps each page at original pixel dimensions.</li>
        <li>Shortcuts: <b>Ctrl+N</b> new, <b>Ctrl+S</b> save, <b>Ctrl+E</b> export PDF, <b>Delete</b> delete image.</li>
      </ol>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button id="closeHow" class="btn primary">Got it</button>
      </div>
    </div>
  </div>

  <!-- Custom confirm & prompt & toast -->
  <div id="confirmPop" class="popup" aria-hidden="true">
    <div class="box">
      <p id="confirmText" style="margin-top:0"></p>
      <div class="row" style="justify-content:flex-end">
        <button id="confirmNo" class="btn ghost">No</button>
        <button id="confirmYes" class="btn primary">Yes</button>
      </div>
    </div>
  </div>
  <div id="promptPop" class="popup" aria-hidden="true">
    <div class="box">
      <p id="promptLabel" style="margin-top:0"></p>
      <input id="promptInput" type="text" placeholder="Type here…">
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button id="promptCancel" class="btn ghost">Cancel</button>
        <button id="promptOk" class="btn primary">OK</button>
      </div>
    </div>
  </div>
  <div id="toast" class="toast"></div>

<script>
/* ============ Utilities & State ============ */
const $ = (id)=>document.getElementById(id);
const libs = { jsPDF: window.jspdf, JSZip: window.JSZip, Sortable: window.Sortable };

let db;
let projects = [];
let current = null;           // active project
let images = [];              // current.images
let selectedIndex = -1;       // editor index
let sortable = null;
let autosaveT = null;

function showToast(msg, t=1400){
  const box = $('toast'); box.textContent = msg; box.classList.add('show');
  clearTimeout(box._t); box._t = setTimeout(()=> box.classList.remove('show'), t);
}
function askConfirm(text){ return new Promise(res=>{ $('confirmText').textContent=text; $('confirmPop').classList.add('show'); $('confirmYes').onclick=()=>{ $('confirmPop').classList.remove('show'); res(true); }; $('confirmNo').onclick=()=>{ $('confirmPop').classList.remove('show'); res(false); }; }); }
function askPrompt(label, def=''){ return new Promise(res=>{ $('promptLabel').textContent=label; $('promptInput').value=def; $('promptPop').classList.add('show'); $('promptOk').onclick=()=>{ const v=$('promptInput').value.trim(); $('promptPop').classList.remove('show'); res(v||null); }; $('promptCancel').onclick=()=>{ $('promptPop').classList.remove('show'); res(null); }; }); }

function applyTheme(name){
  if(name==='light'){
    document.documentElement.style.setProperty('--panel','#ffffff');
    document.documentElement.style.setProperty('--text','#0f172a');
    document.documentElement.style.setProperty('--sub','rgba(15,23,42,.7)');
    document.documentElement.style.setProperty('--bg','#f6f9fc');
  }else if(name==='pastel'){
    document.documentElement.style.setProperty('--panel','#fff7ed');
    document.documentElement.style.setProperty('--text','#13233b');
    document.documentElement.style.setProperty('--sub','rgba(19,35,59,.7)');
    document.documentElement.style.setProperty('--bg','#fffaf0');
  }else{
    document.documentElement.style.setProperty('--panel','#0f1724');
    document.documentElement.style.setProperty('--text','#e7eef8');
    document.documentElement.style.setProperty('--sub','rgba(231,238,248,.75)');
    document.documentElement.style.setProperty('--bg','#0b1220');
  }
  localStorage.setItem('theme', name);
}

/* ============ IndexedDB ============ */
async function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open('ImageProjectsDB_v2',1);
    req.onupgradeneeded = (e)=>{
      db = e.target.result;
      if(!db.objectStoreNames.contains('projects')){
        const st = db.createObjectStore('projects',{ keyPath:'id', autoIncrement:true });
        st.createIndex('name','name',{unique:false});
        st.createIndex('updatedAt','updatedAt',{unique:false});
      }
    };
    req.onsuccess = e=>{ db = e.target.result; resolve(db); };
    req.onerror = e=> reject(e);
  });
}
function dbAll(){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction('projects','readonly');
    const st = tx.objectStore('projects');
    const rq = st.getAll();
    rq.onsuccess = ()=> resolve(rq.result || []);
    rq.onerror = ()=> reject(rq.error);
  });
}
function dbGet(id){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction('projects','readonly');
    const st = tx.objectStore('projects');
    const rq = st.get(id);
    rq.onsuccess = ()=> resolve(rq.result || null);
    rq.onerror = ()=> reject(rq.error);
  });
}
function dbPut(obj){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction('projects','readwrite');
    const st = tx.objectStore('projects');
    const copy = JSON.parse(JSON.stringify(obj));
    if(copy.id===undefined || copy.id===null || Number.isNaN(copy.id)) delete copy.id;
    const rq = st.put(copy);
    rq.onsuccess = ()=> resolve(rq.result);
    rq.onerror = ()=> reject(rq.error);
  });
}
function dbDelete(id){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction('projects','readwrite');
    const st = tx.objectStore('projects');
    const rq = st.delete(id);
    rq.onsuccess = ()=> resolve(true);
    rq.onerror = ()=> reject(rq.error);
  });
}

/* ============ Projects UI ============ */
function renderProjectList(){
  const list = $('projectList'); list.innerHTML='';
  const q = $('searchProjects').value.trim().toLowerCase();
  projects.sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
  for(const p of projects){
    if(q && !p.name.toLowerCase().includes(q)) continue;
    const item = document.createElement('div');
    item.className = 'project-item';
    item.dataset.id = p.id;
    const left = document.createElement('div');
    left.innerHTML = `<div class="project-title">${p.name}</div><div class="muted">${(p.images||[]).length} images · ${new Date(p.updatedAt||p.createdAt).toLocaleString()}</div>`;
    const actions = document.createElement('div');
    actions.innerHTML = `
      <button class="btn ghost sm open"><i class="ph ph-folder-open"></i> Open</button>
      <button class="btn ghost sm rename"><i class="ph ph-pencil"></i></button>
      <button class="btn warn sm del"><i class="ph ph-trash"></i></button>`;
    item.append(left, actions);
    if(current && current.id===p.id) item.classList.add('active');

    actions.querySelector('.open').onclick = (e)=>{ e.stopPropagation(); loadProject(p.id); };
    actions.querySelector('.rename').onclick = async (e)=>{ e.stopPropagation(); const v = await askPrompt('Rename project', p.name); if(v){ p.name=v; p.updatedAt=Date.now(); await dbPut(p); await refresh(); showToast('Renamed'); } };
    actions.querySelector('.del').onclick = async (e)=>{ e.stopPropagation(); if(await askConfirm(`Delete "${p.name}"?`)){ await dbDelete(p.id); if(current && current.id===p.id){ current=null; images=[]; renderGrid(); } await refresh(); showToast('Deleted'); } };

    item.onclick = ()=> loadProject(p.id);
    list.appendChild(item);
  }
}
async function refresh(){ projects = await dbAll(); renderProjectList(); }
function highlightActive(){ [...$('projectList').children].forEach(c=>c.classList.toggle('active', current && Number(c.dataset.id)===current.id)); }

/* ============ Image helpers ============ */
function generateId(){ return Math.random().toString(36).slice(2,9); }
function fileToDataURL(file, maxW=2400, maxH=2400, q=0.85){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onerror = reject;
    reader.onload = ()=>{
      const img = new Image();
      img.onload = ()=>{
        const ratio = Math.min(maxW/img.naturalWidth, maxH/img.naturalHeight, 1);
        const w = Math.round(img.naturalWidth*ratio), h = Math.round(img.naturalHeight*ratio);
        const c = document.createElement('canvas'); c.width=w; c.height=h;
        const ctx = c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
        let hasAlpha=false;
        try{ const d=ctx.getImageData(0,0,Math.min(w,10),Math.min(h,10)).data; for(let i=3;i<d.length;i+=4){ if(d[i]<255){ hasAlpha=true; break; } } }catch(e){}
        resolve(c.toDataURL(hasAlpha?'image/png':'image/jpeg', hasAlpha?undefined:q));
      };
      img.onerror = reject;
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
}
function updateCount(){ $('imgCount').textContent = `${images.length} images`; }

/* ============ Grid (thumbs) ============ */
function renderGrid(){
  const grid = $('grid'); grid.innerHTML='';
  images.forEach((it, i)=>{
    const card = document.createElement('div'); card.className='thumb';
    const badge = document.createElement('div'); badge.className='badge'; badge.textContent = `#${i+1}`;
    const img = document.createElement('img'); img.src = it.data; img.alt = `image ${i+1}`;
    const actions = document.createElement('div'); actions.className='actions';
    const editBtn = document.createElement('button'); editBtn.className='icon-btn'; editBtn.innerHTML='<i class="ph ph-pencil"></i>';
    const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.innerHTML='<i class="ph ph-trash"></i>';
    actions.append(editBtn, delBtn);
    editBtn.onclick = (e)=>{ e.stopPropagation(); openEditor(i); };
    delBtn.onclick = async (e)=>{ e.stopPropagation(); if(await askConfirm('Delete this image?')){ images.splice(i,1); renderGrid(); scheduleAutosave(); showToast('Image removed'); } };
    img.addEventListener('contextmenu',(e)=>{ e.preventDefault(); openEditor(i); });
    card.append(badge, actions, img);
    grid.appendChild(card);
  });
  updateCount();
  if(sortable) sortable.destroy();
  sortable = libs.Sortable.create(grid, {
    animation: 200,
    onEnd: (evt)=>{ const moved = images.splice(evt.oldIndex,1)[0]; images.splice(evt.newIndex,0,moved); renderGrid(); scheduleAutosave(); }
  });
  highlightActive();
}

/* ============ Editor (preview + tools) ============ */
const canvas = $('canvas'), ctx = canvas.getContext('2d');
let cropMode = false, dragging=false, start=null, rect=null;

function loadImage(src){ return new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }

function updatePageLabel(){ $('pageLabel').textContent = `${selectedIndex+1} / ${images.length}`; }

async function draw(meta){
  const img = await loadImage(meta.data);
  const maxW = Math.min(window.innerWidth*0.85, img.naturalWidth);
  const maxH = Math.min(window.innerHeight*0.7, img.naturalHeight);
  const s = Math.min(maxW/img.naturalWidth, maxH/img.naturalHeight, 1);
  const w = Math.round(img.naturalWidth*s), h = Math.round(img.naturalHeight*s);
  // rotation swap
  const rot = ((meta.rotation||0)%360+360)%360;
  const swap = rot===90 || rot===270;
  canvas.width = swap? h : w; canvas.height = swap? w : h;

  ctx.save(); ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.translate(canvas.width/2, canvas.height/2);
  ctx.rotate(rot*Math.PI/180);
  ctx.scale(meta.flipX?-1:1, meta.flipY?-1:1);
  ctx.drawImage(img, -w/2, -h/2, w, h);
  ctx.restore();
}

function openEditor(index){
  if(index<0 || index>=images.length) return;
  selectedIndex = index;
  $('editorModal').classList.add('show');
  cropMode = false; rect=null;
  updatePageLabel();
  draw(images[selectedIndex]);
}
function closeEditor(){ $('editorModal').classList.remove('show'); selectedIndex=-1; cropMode=false; rect=null; }
$('closeEditor').onclick = closeEditor;

$('prevImg').onclick = ()=>{ if(selectedIndex>0){ selectedIndex--; updatePageLabel(); draw(images[selectedIndex]); } };
$('nextImg').onclick = ()=>{ if(selectedIndex<images.length-1){ selectedIndex++; updatePageLabel(); draw(images[selectedIndex]); } };

$('rotL').onclick = ()=>{ if(selectedIndex<0) return; images[selectedIndex].rotation = ((images[selectedIndex].rotation||0)-90); draw(images[selectedIndex]); renderGrid(); scheduleAutosave(); };
$('rotR').onclick = ()=>{ if(selectedIndex<0) return; images[selectedIndex].rotation = ((images[selectedIndex].rotation||0)+90); draw(images[selectedIndex]); renderGrid(); scheduleAutosave(); };
$('flipH').onclick = ()=>{ if(selectedIndex<0) return; images[selectedIndex].flipX = !images[selectedIndex].flipX; draw(images[selectedIndex]); renderGrid(); scheduleAutosave(); };
$('flipV').onclick = ()=>{ if(selectedIndex<0) return; images[selectedIndex].flipY = !images[selectedIndex].flipY; draw(images[selectedIndex]); renderGrid(); scheduleAutosave(); };
$('cropBtn').onclick = ()=>{ cropMode = !cropMode; showToast(cropMode? 'Crop mode: drag to select':'Crop off'); rect=null; };

canvas.addEventListener('mousedown', (e)=>{
  if(!cropMode) return;
  const r = canvas.getBoundingClientRect();
  dragging=true; start={ x:e.clientX-r.left, y:e.clientY-r.top }; rect=null;
});
canvas.addEventListener('mousemove', (e)=>{
  if(!cropMode || !dragging) return;
  const r = canvas.getBoundingClientRect();
  const x=e.clientX-r.left, y=e.clientY-r.top;
  rect={ x:Math.min(start.x,x), y:Math.min(start.y,y), w:Math.abs(x-start.x), h:Math.abs(y-start.y) };
  draw(images[selectedIndex]).then(()=>{
    if(rect){ ctx.save(); ctx.fillStyle='rgba(0,0,0,.45)'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.clearRect(rect.x,rect.y,rect.w,rect.h); ctx.strokeStyle='rgba(96,165,250,.95)'; ctx.lineWidth=2; ctx.strokeRect(rect.x,rect.y,rect.w,rect.h); ctx.restore(); }
  });
});
canvas.addEventListener('mouseup', ()=>{
  if(!cropMode || !dragging) return; dragging=false;
  if(rect && rect.w>8 && rect.h>8){
    const tmp = document.createElement('canvas'); tmp.width=rect.w; tmp.height=rect.h;
    const tctx = tmp.getContext('2d'); tctx.drawImage(canvas, rect.x, rect.y, rect.w, rect.h, 0,0,rect.w,rect.h);
    images[selectedIndex].data = tmp.toDataURL('image/jpeg', Number($('quality').value)/100);
    images[selectedIndex].rotation=0; images[selectedIndex].flipX=false; images[selectedIndex].flipY=false;
    rect=null; cropMode=false;
    draw(images[selectedIndex]); renderGrid(); scheduleAutosave(); showToast('Cropped');
  }else{ rect=null; draw(images[selectedIndex]); }
});

$('dlImg').onclick = ()=>{
  if(selectedIndex<0) return;
  const a = document.createElement('a'); a.href = images[selectedIndex].data; a.download = `image-${selectedIndex+1}.jpg`; a.click();
};
$('delImg').onclick = async ()=>{
  if(selectedIndex<0) return;
  if(await askConfirm('Delete this image?')){ images.splice(selectedIndex,1); renderGrid(); scheduleAutosave(); closeEditor(); showToast('Image deleted'); }
};

/* ============ PDF Export (original sizes) ============ */
async function renderFinal(meta){
  const img = await loadImage(meta.data);
  const w = img.naturalWidth, h = img.naturalHeight;
  const rot = ((meta.rotation||0)%360+360)%360;
  const swap = rot===90 || rot===270;
  const cw = swap?h:w, ch = swap?w:h;
  const c = document.createElement('canvas'); c.width=cw; c.height=ch;
  const cctx = c.getContext('2d');
  cctx.save(); cctx.translate(cw/2,ch/2); cctx.rotate(rot*Math.PI/180);
  cctx.scale(meta.flipX?-1:1, meta.flipY?-1:1);
  cctx.drawImage(img,-w/2,-h/2,w,h);
  cctx.restore();
  return c.toDataURL('image/jpeg', Number($('quality').value)/100);
}
async function exportPDF(){
  if(!images.length) return showToast('No images');
  const { jsPDF } = libs.jsPDF;
  let pdf=null;
  for(let i=0;i<images.length;i++){
    const final = await renderFinal(images[i]);
    const im = await loadImage(final);
    const ptW = im.naturalWidth*0.75, ptH = im.naturalHeight*0.75; // 1px ≈ 0.75pt
    const orient = ptW>=ptH?'l':'p';
    if(i===0) pdf = new jsPDF({ orientation:orient, unit:'pt', format:[ptW,ptH] });
    else pdf.addPage([ptW,ptH], orient);
    pdf.addImage(final, final.startsWith('data:image/png')?'PNG':'JPEG', 0,0,ptW,ptH);
  }
  pdf.save(`${current?.name||'project'}.pdf`);
  showToast('PDF exported');
}

/* ============ ZIP Export & Share ============ */
async function exportZIP(){
  if(!current) return showToast('Open a project first');
  const zip = new libs.JSZip();
  const meta = { project: current, images };
  zip.file('project.json', JSON.stringify(meta,null,2));
  const folder = zip.folder('images');
  for(let i=0;i<images.length;i++){
    const d = images[i].data;
    const base = d.split(',')[1];
    const mime = (d.match(/^data:(image\/[a-z]+)/)||[])[1]||'image/jpeg';
    const ext = mime.split('/')[1];
    folder.file(`img-${i+1}.${ext}`, base, { base64:true });
  }
  const blob = await zip.generateAsync({type:'blob'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${current.name||'project'}.zip`; a.click(); URL.revokeObjectURL(a.href);
  showToast('ZIP exported');
}
async function sharePDF(){
  if(!images.length) return showToast('No images');
  const { jsPDF } = libs.jsPDF;
  let pdf=null;
  for(let i=0;i<images.length;i++){
    const final = await renderFinal(images[i]);
    const im = await loadImage(final);
    const w = im.naturalWidth*0.75, h = im.naturalHeight*0.75;
    if(i===0) pdf = new jsPDF({orientation:w>=h?'l':'p', unit:'pt', format:[w,h]});
    else pdf.addPage([w,h]);
    pdf.addImage(final, final.startsWith('data:image/png')?'PNG':'JPEG', 0,0,w,h);
  }
  const blob = pdf.output('blob'); const file = new File([blob], `${current?.name||'project'}.pdf`, {type:'application/pdf'});
  if(navigator.canShare && navigator.canShare({files:[file]})){
    try{ await navigator.share({files:[file], title: current?.name||'project'}); showToast('Shared'); }catch(e){ showToast('Share canceled'); }
  } else {
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=file.name; a.click(); URL.revokeObjectURL(url); showToast('Downloaded PDF');
  }
}

/* ============ Project Ops ============ */
async function createProject(name){
  const nm = (name && name.trim()) || $('projectName').value.trim() || `Project ${new Date().toLocaleDateString()}`;
  if(!nm) return showToast('Enter a project name');
  const p = { name:nm, images:[], tags:[], createdAt:Date.now(), updatedAt:Date.now(), settings:{ quality:Number($('quality').value) } };
  const key = await dbPut(p);
  await refresh();
  await loadProject(key);
  $('projectName').value='';
  showToast('Project created');
}
async function loadProject(id){
  const p = await dbGet(Number(id));
  if(!p){ showToast('Project not found'); return; }
  current = JSON.parse(JSON.stringify(p));
  images = current.images || [];
  renderGrid(); updateCount(); highlightActive();
  localStorage.setItem('lastProject', current.id);
  showToast('Project loaded');
}
async function saveProject(){
  if(!current) return showToast('Open a project first');
  current.images = images;
  current.updatedAt = Date.now();
  const assigned = await dbPut(current);
  if(assigned) current.id = assigned;
  await refresh();
  highlightActive();
  showToast('Saved');
}
async function renameProject(){
  if(!current) return showToast('Open a project first');
  const nm = await askPrompt('Rename project', current.name);
  if(!nm) return;
  current.name = nm; current.updatedAt = Date.now();
  await dbPut(current); await refresh(); highlightActive(); showToast('Renamed');
}
async function duplicateProject(){
  if(!current) return showToast('Open a project first');
  const copy = JSON.parse(JSON.stringify(current)); delete copy.id; copy.name += ' (copy)'; copy.createdAt=Date.now(); copy.updatedAt=Date.now();
  const key = await dbPut(copy); await refresh(); await loadProject(key); showToast('Duplicated');
}
async function deleteProject(){
  if(!current) return showToast('Open a project first');
  if(await askConfirm(`Delete "${current.name}"?`)){ await dbDelete(current.id); current=null; images=[]; renderGrid(); await refresh(); showToast('Deleted'); }
}
function scheduleAutosave(){
  if(!current) return;
  clearTimeout(autosaveT);
  autosaveT = setTimeout(async ()=>{
    current.images = images; current.updatedAt = Date.now();
    await dbPut(current); await refresh(); highlightActive(); showToast('Autosaved');
  }, 1000);
}

/* ============ Events wiring ============ */
$('createBtn').onclick = ()=> createProject();
$('saveBtn').onclick   = ()=> saveProject();
$('renameBtn').onclick = ()=> renameProject();
$('dupBtn').onclick    = ()=> duplicateProject();
$('delBtn').onclick    = ()=> deleteProject();
$('refreshBtn').onclick= ()=> refresh();

$('pdfBtn').onclick = ()=> exportPDF();
$('zipBtn').onclick = ()=> exportZIP();
$('shareBtn').onclick = ()=> sharePDF();

$('importBtn').onclick = ()=> $('importFile').click();
$('importFile').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text(); const obj = JSON.parse(txt);
    delete obj.id; obj.name = (obj.name||'Imported Project') + ' (import)';
    const key = await dbPut(obj);
    await refresh(); await loadProject(key); showToast('Imported');
  }catch{ showToast('Invalid JSON'); }
  e.target.value='';
});

$('quality').addEventListener('input', ()=> $('qualityVal').textContent = $('quality').value);
$('searchProjects').addEventListener('input', renderProjectList);

$('theme').addEventListener('change', (e)=> applyTheme(e.target.value));

$('howBtn').onclick = ()=> $('howPopup').classList.add('show');
$('closeHow').onclick = ()=> $('howPopup').classList.remove('show');

$('fileInput').addEventListener('change', async (e)=>{
  if(!current){ showToast('Create/open a project first'); e.target.value=''; return; }
  const files = [...e.target.files]; if(!files.length) return;
  const q = Number($('quality').value)/100; showToast('Adding images…');
  for(const f of files){ const data = await fileToDataURL(f,2400,2400,q); images.push({ id:generateId(), data, rotation:0, flipX:false, flipY:false }); }
  renderGrid(); scheduleAutosave(); e.target.value='';
});

$('dropzone').addEventListener('dragover',(e)=>{ e.preventDefault(); $('dropzone').classList.add('drag'); });
$('dropzone').addEventListener('dragleave',()=> $('dropzone').classList.remove('drag'));
$('dropzone').addEventListener('drop', async (e)=>{
  e.preventDefault(); $('dropzone').classList.remove('drag');
  if(!current) return showToast('Create/open a project first');
  const files = [...e.dataTransfer.files]; const q = Number($('quality').value)/100;
  for(const f of files){ if(f.type.startsWith('image/')){ const data = await fileToDataURL(f,2400,2400,q); images.push({ id:generateId(), data, rotation:0, flipX:false, flipY:false }); } }
  renderGrid(); scheduleAutosave();
});

/* Keyboard shortcuts */
window.addEventListener('keydown', async (e)=>{
  if(e.ctrlKey && e.key.toLowerCase()==='n'){ e.preventDefault(); const nm = await askPrompt('New project name'); if(nm) createProject(nm); }
  if(e.ctrlKey && e.key.toLowerCase()==='s'){ e.preventDefault(); saveProject(); }
  if(e.ctrlKey && e.key.toLowerCase()==='e'){ e.preventDefault(); exportPDF(); }
  if($('editorModal').classList.contains('show')){
    if(e.key==='ArrowLeft'){ e.preventDefault(); $('prevImg').click(); }
    if(e.key==='ArrowRight'){ e.preventDefault(); $('nextImg').click(); }
    if(e.key==='Delete'){ e.preventDefault(); $('delImg').click(); }
  }
});

/* ============ Init ============ */
(async function init(){
  await openDB();
  await refresh();

  // theme
  applyTheme(localStorage.getItem('theme')||'dark');
  $('theme').value = localStorage.getItem('theme')||'dark';

  // restore last project
  const last = localStorage.getItem('lastProject');
  if(last){
    const p = await dbGet(Number(last));
    if(p) await loadProject(p.id);
  }

  // first-run how-to
  if(!localStorage.getItem('seenHow')){
    $('howPopup').classList.add('show');
    localStorage.setItem('seenHow','1');
  }
})();
</script>
</body>
</html>
